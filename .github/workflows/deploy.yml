name: Deploy to Production

on:
  push:
    branches: [master]
  workflow_dispatch:  # Allow manual triggering from GitHub UI

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt


  deploy:
    name: Deploy to Server
    needs: pre-deployment-checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        env:
          REPO_URL: https://github.com/CnCNet/cncnet-ladder-bot.git
          DISCORD_CLIENT_SECRET: ${{ secrets.DISCORD_CLIENT_SECRET }}
          DEBUG_MODE: ${{ secrets.DEBUG || 'false' }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          envs: REPO_URL,DISCORD_CLIENT_SECRET,DEBUG_MODE
          script: |
            echo "ðŸš€ Starting deployment..."
            echo "Repository: $REPO_URL"
            echo "Deploy path: ${{ secrets.DEPLOY_PATH }}"
            echo ""

            # Check if we need to clone the repository
            if [ ! -d "${{ secrets.DEPLOY_PATH }}/.git" ]; then
              echo "ðŸ“¥ First-time deployment detected (no git repository found)"

              # Remove directory if it exists but is not a git repo
              if [ -d "${{ secrets.DEPLOY_PATH }}" ]; then
                echo "   Removing existing non-git directory..."
                # Make all files writable to avoid permission issues with __pycache__
                chmod -R +w "${{ secrets.DEPLOY_PATH }}" 2>/dev/null || true
                # Force remove everything (use sudo if regular rm fails)
                rm -rf "${{ secrets.DEPLOY_PATH }}" || sudo rm -rf "${{ secrets.DEPLOY_PATH }}"
              fi

              echo "   Creating deployment directory and cloning repository..."

              # Ensure parent directory exists
              PARENT_DIR=$(dirname "${{ secrets.DEPLOY_PATH }}")
              mkdir -p "$PARENT_DIR"

              # Clone the repository
              echo "   Cloning from $REPO_URL..."
              git clone "$REPO_URL" "${{ secrets.DEPLOY_PATH }}"
              echo "   âœ… Repository cloned successfully"
              echo ""
            fi

            # Navigate to deployment directory
            cd "${{ secrets.DEPLOY_PATH }}"

            # Create .env file from GitHub Secrets
            echo "ðŸ” Creating .env file from GitHub Secrets..."
            cat > src/.env << EOF
            DISCORD_CLIENT_SECRET="$DISCORD_CLIENT_SECRET"
            DEBUG=$DEBUG_MODE
            EOF
            echo "   âœ… .env file created"
            echo ""

            # Ensure deploy script is executable
            chmod +x scripts/deploy.sh

            # Run deployment script
            ./scripts/deploy.sh

      - name: Deployment status
        if: success()
        run: |
          echo "================================================"
          echo "âœ… Deployment completed successfully!"
          echo "================================================"
          echo "Server: ${{ secrets.SERVER_HOST }}"
          echo "Time: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "================================================"

      - name: Deployment failed
        if: failure()
        run: |
          echo "================================================"
          echo "âŒ Deployment failed!"
          echo "================================================"
          echo "Please check the logs above for details"
          echo "You can rollback manually by SSHing to the server"
          echo "and running: ./scripts/rollback.sh ~/bot-backups/backup_TIMESTAMP"
          echo "================================================"
          exit 1
